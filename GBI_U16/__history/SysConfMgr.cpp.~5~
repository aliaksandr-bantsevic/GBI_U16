//---------------------------------------------------------------------------

#pragma hdrstop

#include "SysConfMgr.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)


   TSysConfMgr::TSysConfMgr()
   {
		ini = new TIniFile(ChangeFileExt(Application->ExeName,L".gcf"));
		strcpy(cur_conf_path,L"");
		strcpy(cur_base_path,L"");
		strcpy(cur_conf_fold_path,L"");
		backup_limit = 1.0;
		auto_backup_flag = false;
		auto_backup_flag_completed = false;
   }

   TSysConfMgr::~TSysConfMgr()
   {

   }

   TIniFile* TSysConfMgr::GetIniFile(void)
   {
		GetCurConf();
		return ini;
   }

   void TSysConfMgr::GetCurConf(void)
   {

		wcscpy(cur_conf_path,L"");
		wcscpy(cur_base_path,L"");
		wcscpy(cur_conf_fold_path,L"");

		TIniFile *inigcf = new TIniFile(ChangeFileExt(Application->ExeName,L".gcf"));

		WideString sname(L"");
		sname = inigcf ->ReadString(L"GENERAL",L"CONFNAME",L"GBI");
		wcscpy(cur_conf_name,sname.c_str());
		sname = sname + ".ini";

		backup_limit = (double) inigcf ->ReadInteger(L"BACKUP",L"PERIOD",7.0);

		::GetCurrentDirectoryW(1024,cur_conf_path);
		::GetCurrentDirectoryW(1024,cur_base_path);
		::GetCurrentDirectoryW(1024,cur_back_fold_path);

		strcat(cur_conf_path,L"\\Config\\");
		if (!DirectoryExists(cur_conf_path))  CreateDirectory(cur_conf_path,0);
		wcscpy(cur_conf_fold_path,cur_conf_path);

		strcat(cur_back_fold_path,L"\\Backup\\");
		if (!DirectoryExists(cur_back_fold_path))  CreateDirectory(cur_back_fold_path,0);

		strcat(cur_base_path,L"\\Base\\");
		if (!DirectoryExists(cur_base_path))  CreateDirectory(cur_base_path,0);
		wcscpy(cur_base_fold_path,cur_base_path);
		strcat(cur_base_path,cur_conf_name);
		strcat(cur_base_path,L"\\");
		if (!DirectoryExists(cur_base_path))  CreateDirectory(cur_base_path,0);


		strcat(cur_conf_path,sname.c_str());

		if (ini != NULL) delete ini;

		ini = new TIniFile (cur_conf_path);

		AutoBackup();
   }

   TCHAR** TSysConfMgr::GetCurBase(void)
   {
		return cur_base_path;
   }

   TCHAR** TSysConfMgr::GetCurIniPath(void)
   {
		return cur_conf_path;
   }

   TCHAR** TSysConfMgr::GetCurConfFoldPath(void)
   {
		return cur_conf_fold_path;
   }

   TCHAR** TSysConfMgr::GetCurBaseFoldPath(void)
   {
		return cur_base_fold_path;
   }

   TCHAR** TSysConfMgr::GetCurBackFoldPath(void)
   {
		return cur_back_fold_path;
   }

   void TSysConfMgr::SaveCurConf(void)
   {
		TIniFile *inigcf = new TIniFile(ChangeFileExt(Application->ExeName,".gcf"));
		inigcf ->WriteString("GENERAL","CONFNAME",cur_conf_name);

		inigcf ->WriteInteger("BACKUP","PERIOD",(int)backup_limit);
   }

   int TSysConfMgr::Accept(TCHAR** cnew)
   {
		wcscpy(cur_conf_name,cnew);
		SaveCurConf();
		return 0;
   }


   int TSysConfMgr::AutoBackup(void)
   {
		if (auto_backup_flag == true ) {

			return -1;
		}

		Backup(1,0);

		auto_backup_flag = true;
		return 0;
   }

   int TSysConfMgr::Backup(int autobackup, int showmsg)
   {

		if (autobackup != 0)
		{
			if (backup_limit >= 1.0)
			{
				if (backup_limit > GetBckTime()) {

					return -1; //Период резервирования не истек
				}
			}
			else
			{
					return -2; //Авто бэкап отключен
            }

		}


		TDateTime t = Now();
		TCHAR* cdir[1024];
		GetCurrentDirectoryW(1024,cdir);
		WideString sdir(L"");
		sdir = sdir + cdir;

		WideString sgini = ChangeFileExt(Application->ExeName,".gcf");
		WideString sapp = sdir;
		WideString sconf = sdir+"\\Config";
		WideString sbase = sdir+"\\Base";
		WideString sback = sdir+"\\Backup\\";

		//WideString sfold = FormatDateTime("dd_mm_yyyy_hh_nn_ss\\",t);
		WideString sfold = FormatDateTime("yyyy_mm_dd_hh_nn_ss\\",t);

		sback = sback + sfold;
		if (!DirectoryExists(sback.c_str()))  CreateDirectory(sback.c_str(),0);

		WideString cmd("copy ");
		cmd.printf ("copy \"%s\" \"%sGBI.gcf\L"",sgini.c_str(),sback.c_str());
		system(cmd.c_str());
		//ShellExecute(0,"open",cmd.c_str(),0,0,SW_HIDE);

		cmd.printf ("xcopy /s /i \"%s\" \"%sBase\L"",sbase.c_str(),sback.c_str());
		system(cmd.c_str());
		//ShellExecute(0,"open",cmd.c_str(),0,0,SW_HIDE);

		cmd.printf ("xcopy /s /i \"%s\" \"%sConfig\L"",sconf.c_str(),sback.c_str());

		system(cmd.c_str());
		//ShellExecute(0,"open",cmd.c_str(),0,0,SW_HIDE);

		if (autobackup == 0)
		{
			WideString msg(L"");
			sfold[strlen(sfold.c_str())] = '\0';
			msg.printf("Резервная копия базы сохранена в папке ../Backup/%s",sfold.c_str());
			if (showmsg) MessageBox(NULL,msg.c_str(),"РЕЗЕРВНОЕ КОПИРОВАНИЕ",0);
		}
		else
		{
			//ShowMessage("Auto backup!");
			auto_backup_flag_completed = true;
		}

		return 0;
   }


#define T_ONE_DAY       (1.)
#define T_ONE_HOUR      (1./24.)
#define T_ONE_MIN       (1./(24.*60.))
#define T_ONE_SEC       (1./(24.*60.*60.))
#define T_ONE_MSEC      ((1./(24.*60.*60.))/1000)
#define T_ONE_DSEC      ((1./(24.*60.*60.))/10)

//Сколько дней прошло посе последнего бэкапа
   double TSysConfMgr::GetBckTime (void)
   {

		double dayage = 0.0;

//Сюда будем читать атрибуты папки
		WIN32_FIND_DATA FileDataAtr;

		WideString fpath(L"");
		int idx=0;
		LONGLONG T = 0;
		LONGLONG Tmax = 0;

//Хэндл для поиска файлов в папке
		WIN32_FIND_DATA w32fd;
		HANDLE hFind;

//Путь к папке с файлами
		TCHAR* dbpath [1024];
		wcscpy(dbpath,GetCurBackFoldPath());

//Маска
		TCHAR* cpar[1024];
		sprintf(cpar,"*.*");
		strcat(dbpath,cpar);

//Читаем первый файл в папке
		hFind=FindFirstFile(dbpath,&w32fd);

		SYSTEMTIME sysTime;
		FILETIME creationTime;
		FILETIME localfiletime;

//В папке нет файлов
		if ((hFind==INVALID_HANDLE_VALUE)||(hFind==NULL))
		{
			return 0.0;
		}
//Если файлы есть читаем весь директорий
		else
		{
				  FileDataAtr = w32fd;
				  T=FileDataAtr.ftCreationTime.dwHighDateTime;
				  T<<=4;
				  T+=FileDataAtr.ftCreationTime.dwLowDateTime;

				  int lh = sizeof(FileDataAtr.ftCreationTime.dwHighDateTime);
				  int ll = sizeof(FileDataAtr.ftCreationTime.dwLowDateTime);

				  if (T>Tmax)
				  {
					Tmax = T;
					creationTime = FileDataAtr.ftCreationTime;
				  }

					while(FindNextFile( hFind, &w32fd))
					{
						  FileDataAtr = w32fd;
						  T=FileDataAtr.ftCreationTime.dwHighDateTime;
						  T<<=4;
						  T+=FileDataAtr.ftCreationTime.dwLowDateTime;

						  if (T>Tmax)
						  {
							Tmax = T;
                            creationTime = FileDataAtr.ftCreationTime;
						  }

					}

					/*
			//GetFileTime(hFind, &creationTime, 0, 0);
			creationTime = FileDataAtr.ftCreationTime;
			FileTimeToLocalFileTime(&creationTime,&localfiletime);
			FileTimeToSystemTime(&localfiletime, &sysTime);

			unsigned short year, mon, day, hour, min, sec, msec = 0;

			year = sysTime.wYear; mon = sysTime.wMonth; day = sysTime.wDay;
			hour = sysTime.wHour; min = sysTime.wMinute; sec = sysTime.wSecond; msec = sysTime.wMilliseconds;
			TDateTime ct = TDateTime(year,mon,day) + TDateTime(hour,min,sec,msec);
			TDateTime age = Now() - ct;
			dayage = (double)age;

			//dayage/=T_ONE_DAY;

			dayage/=T_ONE_MIN;
					*/
		}

			//GetFileTime(hFind, &creationTime, 0, 0);
			creationTime = FileDataAtr.ftCreationTime;
			FileTimeToLocalFileTime(&creationTime,&localfiletime);
			FileTimeToSystemTime(&localfiletime, &sysTime);

			unsigned short year, mon, day, hour, min, sec, msec = 0;

			year = sysTime.wYear; mon = sysTime.wMonth; day = sysTime.wDay;
			hour = sysTime.wHour; min = sysTime.wMinute; sec = sysTime.wSecond; msec = sysTime.wMilliseconds;
			TDateTime ct = TDateTime(year,mon,day) + TDateTime(hour,min,sec,msec);
			TDateTime age = Now() - ct;
			dayage = (double)age;

			dayage/=T_ONE_DAY;
			//dayage/=T_ONE_MIN;


	return dayage;
}


